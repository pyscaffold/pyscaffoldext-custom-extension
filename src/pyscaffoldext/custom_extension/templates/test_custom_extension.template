from pathlib import Path

from pyscaffold import cli
from pyscaffold.file_system import chdir

from pyscaffoldext.${package}.extension import ${extension_class_name}

EXT_FLAG = ${extension_class_name}().flag


def test_add_custom_extension(tmpfolder):
    args = ["--no-config", EXT_FLAG, "my_project", "-p", "my_package"]
    # --no-config: avoid extra config from dev's machine interference
    cli.main(args)

    assert Path("my_project/src/my_package/__init__.py").exists()


def test_generated_extension_flake8(tmpfolder, venv_run):
    args = ["--no-config", EXT_FLAG, "my_project"]
    # --no-config: avoid extra config from dev's machine interference
    cli.main(args)

    with chdir("my_project"):
        assert "" == venv_run("flake8")
        venv_run("python setup.py install")

    venv_run(f"putup {EXT_FLAG} the_actual_project")
    assert Path("the_actual_project/setup.cfg").exists()

    with chdir("the_actual_project"):
        assert "" == venv_run("flake8")
